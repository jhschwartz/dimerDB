import sys
import os
import yaml

configfile: 'config.yaml'

sys.path.append(config['paths']['scripts'])
from simple_write import simple_write

out_base_dir = config['paths']['intermediates_dimer_filtering']

homodimers_yaml = config['snake_data_yaml_files']['sub1_all_homodimers_yaml']
heterodimers_yaml = config['snake_data_yaml_files']['sub1_all_heterodimers_yaml']

with open(homodimers_yaml, 'r') as f:
    data_homodimers = yaml.safe_load(f)
    homodimer_uniparcs = data_homodimers.keys()

with open(heterodimers_yaml, 'r') as f:
    data_heterodimers = yaml.safe_load(f)
    heterodimer_uniparc_pairs = data_heterodimers.keys()


homodimers_divs = {}
heterodimers_divs = {}

for hu in homodimer_uniparcs:
    div = hu[-2:]
    if div in homodimers_divs:
        homodimers_divs[div].append(hu)
    else:
        homodimers_divs[div] = [ hu ]
for hup in heterodimer_uniparc_pairs:
    left = hup.split('-')[0]
    right = hup.split('-')[1]
    div = left[-1:] + '-' + right[-1:]
    if div in heterodimers_divs:
        heterodimers_divs[div].append(hup)
    else:
        heterodimers_divs[div] = [ hup ]
    


localrules: all, prepare_dirs_homo, prepare_dirs_hetero


rule all:
    input:
        expand(out_base_dir+'/{homo_div}/dir_init.done', homo_div=homodimers_divs.keys()),
        expand(out_base_dir+'/{hetero_div}/dir_init.done', hetero_div=heterodimer_divs.keys())
    output:
        done = config['snake_donefiles']['sub2_all_done']
    run:
        simple_write(output.done, 'success')




rule prepare_dirs_homo:
    output:
        dir_done = expand(out_base_dir+'/{homo_div}/dir_init.done', homo_div=homodimer_divs.keys())
    run:
        for homo_uniparc in homodimer_divs[wildcards.homo_div]:
            data = data_homodimers[homo_uniparc]
            dir_ = os.path.join(out_base_dir, wildcards.homo_div, homo_uniparc)
            outfile = os.path.join(dir_, 'init.yaml')
            os.makdirs(dir_, exist_ok=True)
            with open(outfile, 'w') as f:
                yaml.dump(data, f, default_flow_style=None)
        simple_write(output.dir_done, 'success')
    


rule prepare_dirs_hetero:
    output:
        dir_done = expand(out_base_dir+'/{hetero_div}/dir_init.done', hetero_div=heterodimer_divs.keys())
    run:
        for hetero_uniparc_pair in heterodimer_divs[wildcards.hetero_div]:
            data = data_heterodimers[hetero_uniparc_pair]
            dir_ = os.path.join(out_base_dir, wildcards.hetero_div, hetero_uniparc_pair)
            outfile = os.path.join(dir_, 'init.yaml')
            os.makdirs(dir_, exist_ok=True)
            with open(outfile, 'w') as f:
                yaml.dump(data, f, default_flow_style=None)
        simple_write(output.dir_done, 'success')





