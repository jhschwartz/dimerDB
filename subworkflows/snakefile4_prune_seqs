import os
import sys
import yaml

sys.path.append('..')
from scripts.simple_write import simple_write


intermediates = os.getcwd()



non_redundant_homodimers = 'intermediates/nonredundant_homodimers.yaml'
with open(non_redundant_homodimers, 'r') as f:
	homodimers_dict = yaml.safe_load(f)
	uniprots = list(homodimers_dict.keys())



rule all:
	input:
		'intermediates/working_homodimers.yaml'
	output:
		done = 'intermediates/subflow3.done'
	run:
		simple_write(output.done, 'success')



rule align:
	output:
		list_ = 'intermediates/working_homodimers.yaml'
	threads: 512 # must make multi node...?
	run:
		from scripts.unredundant import RedundantSeqs
		seqs = RedundantSeqs(seq_names=uniprots, threshold=0.7, homodimers_dict=homodimers_dict)
		non_redundant_seqs = seqs.prune_redundancy(num_workers=threads)
		filtered = {homodimers_dict[seqname] for seqname in non_redundant_seqs}
		with open(output.list_, 'w') as f:
			yaml.dump(filtered, f, default_flow_style=None)